<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Map Round Trip Visualization</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 60vh; }
        .controls { margin: 10px; }
        input { padding: 5px; margin-right: 10px; }
        button { padding: 10px 20px; margin-top: 10px; }
        #distance { margin-top: 10px; font-size: 16px; }
        #coordinates { margin-top: 10px; font-size: 14px; max-height: 200px; overflow-y: auto; background-color: #f9f9f9; padding: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="controls">
        <input type="number" id="distanceInput" placeholder="Enter distance in km" />
        <button onclick="generateRoundTrip()">Generate Round Trip</button>
        <div id="distance">Distance: Not calculated</div>
        <div id="coordinates">Coordinates: Not available</div>
    </div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map("map").setView([49.174, -123.184], 15);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);
        let markers = [];

        async function generateRoundTrip() {
            const distanceInput = document.getElementById("distanceInput").value;
            const distance = parseFloat(distanceInput);

            if (!distance || distance <= 0) {
                alert("Please enter a valid distance.");
                return;
            }

            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const user_location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                };

                try {
                    const response = await fetch("http://127.0.0.1:5000/roundtrip", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ user_location, distance }),
                    });

                    if (!response.ok) {
                        throw new Error("Failed to fetch round trip");
                    }

                    const { path, distance: actual_distance } = await response.json();
                    drawRoute(path);
                    document.getElementById("distance").textContent = `Distance: ${actual_distance.toFixed(2)} km`;
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error fetching the round trip.");
                }
            });
        }

        function drawRoute(path) {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const latLngs = path.map(coord => [coord[0], coord[1]]);
            map.fitBounds(latLngs);

            latLngs.forEach((coord, index) => {
                const marker = L.marker(coord).addTo(map).bindPopup(`Point ${index + 1}: ${coord[0]}, ${coord[1]}`);
                markers.push(marker);
            });
            displayCoordinates(latLngs);
        }

        function displayCoordinates(latLngs) {
            const coordinatesDiv = document.getElementById("coordinates");
            coordinatesDiv.innerHTML = latLngs
                .map((coord, index) => `Point ${index + 1}: ${coord[0]}, ${coord[1]}`)
                .join("<br>");
        }
    </script>
</body>
</html>
